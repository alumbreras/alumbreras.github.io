<!DOCTYPE html>
<html lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

        <title>Alberto Lumbreras - The Chinese Restaurant Process</title>

        <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css" />
        <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.1/css/font-awesome.css" rel="stylesheet">

        <link rel="stylesheet" type="text/css" href="../css/syntax.css" />
        <link rel="stylesheet" type="text/css" href="../css/custom.css" />
        <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
        <div class="container">
            <div class="row">
                <div class="col-md-10 col-md-offset-2">
                    <h1 style="color:rgba(153, 153, 153, 0.0);">Alberto Lumbreras
                        <small>
                            <font size="4" style="color:rgba(153, 153, 153, 0.0);">[PhD Student in Computer Science]</font>
                        </small>
                    </h1>
                </div>
            </div>
            <div class="row">
                <div class="col-md-1">
                    <br />
                    <ul class="nav nav-stacked affix" data-spy="affix" data-offset-top="0">
                        <li><a href="../"><i class="fa fa-home fa-lg fa-fw"></i> Home</a></li>
                        <li><a href="../publications.html"><i class="fa fa-list fa-lg fa-fw"></i> Publications</a></li>
                        <li><a href="../posts.html"><i class="fa fa-pencil fa-lg fa-fw"></i> Posts</a></li>
                        <!-- <li><a href="/about.html"><i class="fa fa-male fa-lg fa-fw"></i> About</a></li> -->
                        <li><a href="http://github.com/alumbreras"><i class="fa fa-github fa-lg fa-fw"></i> GitHub</a></li>
                        <li><a href="https://twitter.com/albertlumbreras"><i class="fa fa-twitter fa-lg fa-fw"></i> Twitter</a></li>
                        <li><a href="http://es.linkedin.com/in/albertolumbreras"><i class="fa fa-linkedin fa-lg fa-fw"></i> LinkedIn</a></li> 

                    </ul>
                </div>
                <div class="col-md-10" style="top: -22px;">
                    <h3>The Chinese Restaurant Process</h3>

<small><a href="../posts/2014-02-25-The-Chinese-Restaurant-Process.html">Posted on February 25, 2014</a></small>

<p>The <a href="http://en.wikipedia.org/wiki/Chinese_restaurant_process">Chinese Restaurant Process</a> is a prior for the likelihoods of clustered data. Let <span class="math">\(\mathbf{z}\)</span> be the cluster assignments of users. Let <span class="math">\(K\)</span> be the number of clusters and let <span class="math">\(\boldsymbol{\pi}\)</span> be a vector of size <span class="math">\(K\)</span>, indicating the probability of being assigned to cluster <span class="math">\(k\)</span>. If we put a Dirichlet prior on <span class="math">\(\boldsymbol{\pi}\)</span> , we have:</p>
<p><span class="math">\[
\begin{align}
\mathbf{z} &amp;\sim \text{Multinomial}(\boldsymbol{\pi})\notag\\
\boldsymbol{\pi} &amp;\sim \text{Dirichlet}(\alpha)
\end{align}
\]</span></p>
<p>Assuming that <span class="math">\(\alpha\)</span> is a fixed parameter, the joint probability of <span class="math">\(\mathbf{z}\)</span> and <span class="math">\(\boldsymbol{\pi}\)</span> is: <span class="math">\[
\begin{align}
p(\mathbf{z}, \boldsymbol{\pi}) = 
p(\mathbf{z} | \boldsymbol{\pi})p(\boldsymbol{\pi} | \alpha)
\end{align}
\]</span></p>
<p>If we integrate out <span class="math">\(\mathbf{\pi}\)</span>, we get the marginal probability of <span class="math">\(\mathbf{z}\)</span>:</p>
<p><span class="math">\[
\begin{align}
p(\mathbf{z}) &amp;=
\int_{\boldsymbol{\pi}} 
   p(\mathbf{z} | \boldsymbol{\pi}) 
   p (\boldsymbol{\pi} | \alpha) =
\int_{\boldsymbol{\pi}} 
   \prod_{i=1}^K \pi_i^{n_i} 
   \frac{1}{B(\alpha)}
   \prod_{j=1}^K \pi_j^{\alpha-1}
\end{align}
\]</span></p>
<p>Renaming <span class="math">\(\alpha+n_i\)</span> as <span class="math">\(\alpha_i'\)</span>, multiplying and dividing by <span class="math">\(B(\boldsymbol{\alpha'})\)</span>, and rearranging the elements so that it is visually clear, we get:</p>
<p><span class="math">\[
\begin{align}
p(\mathbf{z})=
\frac{
B(\boldsymbol{\alpha'})
}{
B(\alpha)
}
\int_{\boldsymbol{\pi}}  
   \frac{1}{B(\boldsymbol{\alpha'})}
   \prod_{i=1}^K \pi_i^{\alpha_i' - 1}
\end{align}
\]</span></p>
<p>where the value of the integral is 1, since the factor inside is a Dirichlet density function. Expanding the definition of the Beta function, we get:</p>
<p><span class="math">\[
\begin{align}
p(\mathbf{z})=
\frac{
\prod_{i=1}^K \Gamma(\alpha_i + n_i)
}
{
\Gamma \left(\sum_{i=1}^K \alpha_i + n_i \right)
}
\frac{
\Gamma \left(\sum_{i=1}^K \alpha_i \right)
}
{
\prod_{i=1}^K \Gamma(\alpha_i)
}
\end{align}
\]</span></p>
<p>Note that the presence of the counts <span class="math">\(n_i\)</span> makes it impossible to factorize <span class="math">\(p(\mathbf{z})\)</span> into the product of the individual <span class="math">\(z\)</span>. However, we can derive the conditional probability of one <span class="math">\(z_u\)</span> given all the other assignments:</p>
<p><span class="math">\[
\begin{align}
p(z_u = j| \mathbf{z_{-u}}) =
\frac{p(\mathbf{z})}
{p(\mathbf{z_{-u}})}
\end{align}
\]</span></p>
<p>To compute the denominator we assume cluster assignments are exchangeable, that is, the joint distribution <span class="math">\(p(\mathbf{z})\)</span> is the same regardless the order in which clusters are assigned. This allows us to assume that <span class="math">\(z_u\)</span> is the last assignment, therefore obtaining <span class="math">\(p(\mathbf{z_{-u}})\)</span> by considering how was the equation <span class="math">\(p(\mathbf{z})\)</span> before <span class="math">\(z_u\)</span> was assigned to cluster <span class="math">\(j\)</span>.</p>
<p><span class="math">\[
\begin{align}
p(\mathbf{z_{-u}}) = 
\frac
{
\Gamma(\alpha_j + n_j-1)
\prod_{i\neq j}^K \Gamma(\alpha_i + n_i)
}
{\Gamma
\left(
\alpha_j + n_j -1 + \sum_{i\neq j}^K \alpha_i + n_i 
\right)
}
\frac{
\Gamma \left(\sum_{i=1}^K \alpha_i \right)
}
{
\prod_{i=1}^K \Gamma(\alpha_i)
}
\end{align}
\]</span></p>
<p>Plugging <span class="math">\(p(\mathbf{z}_{-u})\)</span> and <span class="math">\(p(\mathbf{z})\)</span> into <span class="math">\(p(z_u | \mathbf{z}_{-u})\)</span>, we get:</p>
<p><span class="math">\[
\begin{align}
p(z_i = j| \mathbf{z_{-u}}) 
&amp;\propto
\frac{
\prod_{i=1}^K \Gamma(\alpha_i + n_i)
}
{
\Gamma \left(\sum_{i=1}^K \alpha_i + n_i \right)
}
\frac
{\Gamma
\left(
\alpha_j + n_j -1 + \sum_{i\neq j}^K \alpha_i + n_i 
\right)
}
{
\Gamma(\alpha_j + n_j-1)
\prod_{i\neq j}^K \Gamma(\alpha_i + n_i)
}\\
&amp;=
\frac{
\Gamma(\alpha_j + n_j)
\prod_{i \neq j }^K \Gamma(\alpha_i + n_i)
}
{
\Gamma \left(\sum_{i=1}^K \alpha_i + n_i \right)
}
\frac
{\Gamma
\left(
\alpha_j + n_j -1 + \sum_{i\neq j}^K \alpha_i + n_i 
\right)
}
{
\Gamma(\alpha_j + n_j-1)
\prod_{i\neq j}^K \Gamma(\alpha_i + n_i)
}\\
&amp;=
\frac{
\Gamma(\alpha_j + n_j)
}
{
\Gamma \left(\sum_{i=1}^K \alpha_i + n_i \right)
}
\frac
{\Gamma
\left(
\alpha_j + n_j -1 + \sum_{i\neq j}^K \alpha_i + n_i 
\right)
}
{
\Gamma(\alpha_j + n_j-1)
}
\end{align}
\]</span></p>
<p>Assuming that all <span class="math">\(\alpha_i\)</span> have the same value <span class="math">\(\alpha\)</span>, and since the sum of all <span class="math">\(n_i\)</span> is <span class="math">\(U\)</span>:</p>
<p><span class="math">\[
\begin{align}
p(z_i = j| \mathbf{z_{-u}}) 
&amp;\propto
\frac{
\Gamma(\alpha + n_j)
}
{
\Gamma \left(K \alpha + U \right)
}
\frac
{\Gamma
\left(
K\alpha_j +U -1
\right)
}
{
\Gamma(\alpha_j + n_j -1)
}
\end{align}
\]</span></p>
<p>and finally exploiting the fact that <span class="math">\(a \Gamma(a) = \Gamma(a+1)\)</span>:</p>
<p><span class="math">\[
\begin{align}
p(z_i = j| \mathbf{z_{-u}}) 
&amp;\propto
\frac
{\alpha + n_j}
{K \alpha + U -1}
\end{align}
\]</span></p>
<p>we can reparametrize <span class="math">\(\alpha\)</span> as <span class="math">\(\alpha/K\)</span>. Then we have the standard result:</p>
<p><span class="math">\[
\begin{align}
p(z_i = j| \mathbf{z_{-u}}) 
&amp;\propto
\frac
{\alpha/K + n_j}
{\alpha + U -1}
\end{align}
\]</span></p>
<p>where <span class="math">\(n_j\)</span> is the number of users in cluster <span class="math">\(j\)</span> before the assignment of <span class="math">\(z_u\)</span>.</p>
<p>The Chinese Restaurant Process is the consequence of considering <span class="math">\(K \rightarrow \infty\)</span>. For clusters where <span class="math">\(n_j&gt;0\)</span>, we have:</p>
<p><span class="math">\[
\begin{align}
p(z_i = j| \mathbf{z_{-u}}) 
&amp;\propto
\frac
{n_j}
{\alpha + U -1}
\end{align}
\]</span></p>
<p>and the probability of assigning <span class="math">\(z_u\)</span> to any of the (infinite) empty clusters is:</p>
<p><span class="math">\[
\begin{align}
p(z_i = j| \mathbf{z_{-u}}) 
&amp;\propto
K\frac
{\alpha/K}
{\alpha + U -1} = 
\frac
{\alpha}
{\alpha + U -1} 
\end{align}
\]</span></p>
<p>which written in a compact equation is:</p>
<p><span class="math">\[
\begin{align}
p(z_u = j | \mathbf{z_{-u}}, \alpha) = 
\begin{cases}
\frac{n_{-u,j}}{U - 1 + \alpha}&amp; \text{if } n_{-u,j}&gt;0 \\
\frac{\alpha}{U-1 + \alpha}&amp; \text{if } n_{-u,j}=0
\end{cases}
\end{align}
\]</span></p>

<div class="panel panel-default">
    <div class="panel-body">
        <div class="pull-left">
            Tags: <a href="../tags/tutorials.html">tutorials</a>
        </div>
        <div class="social pull-right">
            <span class="twitter">
                <a href="https://twitter.com/share" class="twitter-share-button" data-url="http://www.albertolumbreras.net/posts/2014-02-25-The-Chinese-Restaurant-Process.html" data-via="albertlumbreras" data-dnt="true">Tweet</a>
            </span>
        </div>
    </div>
</div>

<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'albertolumbreras';
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
     var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
     dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
     (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
     })();
    </script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
                </div>
            </div>
        </div>

  
        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
             (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
             m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
             })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
            
            ga('create', 'UA-62494759-1', 'auto');
            ga('send', 'pageview');
            
            </script>
        
    </body>
</html>
